<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GI Symposium — Metro Map (Interactive)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Baloo+2:wght@700&display=swap" rel="stylesheet">
  <style>
    :root{
      /* Poster palette */
      --bg:#FFF9F6;          /* warm paper */
      --ink:#15151a;         /* titles */
      --muted:#6b7280;       /* quiet text */
      --panel:#ffffffcc;     /* glass panel */
      --shadow: 0 6px 22px rgba(0,0,0,.08);
      --node-outline:6px;    /* station outline */
      --route:12px;          /* route thickness */

      /* route colors mapped to poster tones */
      --c-nic:#A88BFE;      /* lavender purple */
      --c-zoy:#7AD7B3;      /* mint green */
      --c-alex:#FFD166;     /* butter yellow */
      --c-eileen:#FF9E80;   /* peach */
      --c-flo:#F8A6D9;      /* bubble‑gum pink */
      --c-laura:#FFBD73;    /* apricot ribbon */
      --c-sri:#7ED4C2;      /* seafoam */
      --c-erin:#7FA8FF;     /* cornflower blue */
      --c-jack:#C266FF;     /* bright violet */
      --c-tom:#A4C8FF;      /* light sky blue */
      --c-ric:#C79A6C;      /* tan brown */
      --c-mil:#FF7FAE;      /* rose */
    }

    html,body{height:100%}
    body{
      margin:0;color:var(--ink);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(900px 600px at 10% -10%, #f6f6ff 0, transparent 60%),
        radial-gradient(900px 600px at 110% 10%, #fff1eb 0, transparent 60%),
        var(--bg);
      overflow:hidden;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }

    header{position:relative;z-index:4;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 14px;border-bottom:1px solid #ececef;background:#ffffffd9;backdrop-filter: blur(8px); flex-wrap:wrap}
    h1{margin:0;font:700 18px/1 'Baloo 2', Inter}
    .sub{color:var(--muted);font-size:13px;margin-left:6px}
    .left{display:flex; align-items:center; gap:10px}
    #btnMenu{border:1px solid #e7e7ef;background:#fff;border-radius:10px;padding:6px 10px;font-weight:700;cursor:pointer;box-shadow:var(--shadow)}
    #btnMenu:active{transform:translateY(1px)}

    .wrap{display:grid;grid-template-columns:360px 1fr; height:calc(100% - 54px)}

    aside{padding:14px;border-right:1px solid #ececef;background:linear-gradient(180deg,#fff 0,#fdfbff 120%);overflow:auto;z-index:5}
    .panel{background:var(--panel);border-radius:16px;padding:12px;box-shadow:var(--shadow);border:1px solid #efeff4;margin-bottom:12px}
    .panel h3{margin:.2rem 0 .6rem;font:700 15px/1 'Baloo 2', Inter}

    .legend-item{display:flex;align-items:center;gap:10px;margin:7px 0; cursor:default}
    .legend-item.active{font-weight:700}
    .swatch{width:28px;height:6px;border-radius:999px;background:#999;box-shadow:inset 0 0 0 1px #00000012}
    .legend-item label{flex:1;display:flex;gap:8px;align-items:center}
    .legend-item input[type="checkbox"]{accent-color:#111;width:16px;height:16px}

    .btn-row{display:flex;flex-wrap:wrap;gap:8px}
    button,.btn{appearance:none;border:1px solid #e7e7ef;background:#fff;border-radius:12px;padding:8px 10px;font-weight:650;cursor:pointer;font-size:13px;box-shadow:var(--shadow);transition:transform .06s ease, background .18s ease}
    button:hover{background:#f8f8ff}
    button:active{transform: translateY(1px)}

    .toggle{display:flex;gap:8px;flex-wrap:wrap}
    .toggle label{display:inline-flex;gap:6px;align-items:center;border:1px solid #e7e7ef;background:#fff;border-radius:999px;padding:6px 10px;font-size:12px;box-shadow:var(--shadow)}

    .controls{display:grid;grid-template-columns: 1fr auto; gap:8px; align-items:center}
    .controls label{font-size:12px;color:var(--muted)}
    .controls input[type="range"]{width:100%}

    #stage{position:relative;height:100%;}
    svg{width:100%;height:100%;display:block;background:#fff;user-select:none;-webkit-user-select:none;-webkit-touch-callout:none}

    .grid{stroke:#f2f2f7;stroke-width:1}

    .route{fill:none;stroke-linecap:round;stroke-linejoin:round;pointer-events:stroke;transition:opacity .15s ease}
    .route:hover{filter: drop-shadow(0 0 0.8px currentColor)}
    .route.hidden{opacity:.12}
    .route.dim{opacity:.15}
    .route.active{opacity:1}

    /* SVG text outline for legibility */
    .station text,.talk text{ fill:#111; stroke:#fff; stroke-width:3px; paint-order: stroke fill; pointer-events:auto; user-select:none }

    .hit{pointer-events:all;cursor:grab;fill-opacity:0}
    .talk rect{fill:#fff;stroke:#0f172a;stroke-width:3px;rx:18;ry:18}
    .station circle{fill:#fff;stroke:#0f172a;stroke-width:var(--node-outline)}
    .station circle.sel{stroke:#111;stroke-width:5px}
    .talk rect.sel{stroke:#111;stroke-width:4px}

    #legend{max-height:240px; overflow:auto; padding-right:6px}

    .zoom{position:absolute;right:14px;bottom:14px;display:flex;gap:8px;z-index:3}
    .zoom button{width:40px;height:40px;border-radius:12px;font-size:18px}

    .toast{position:absolute;bottom:12px;left:12px;background:#111;color:#fff;padding:8px 10px;border-radius:12px;font-size:12px;opacity:0;transform:translateY(6px);transition:.25s}
    .toast.show{opacity:1;transform:translateY(0)}

    .sep{height:1px;background:#efeff4;margin:10px 0}
    .hint{color:var(--muted);font-size:12px;margin-top:4px}
    input[type="file"]{display:none}
    label.file{display:inline-flex;gap:6px;align-items:center}

    /* Mobile drawer */
    .scrim{position:fixed; inset:54px 0 0 0; background:rgba(0,0,0,.08); opacity:0; pointer-events:none; transition:.2s; z-index:4}
    @media (max-width: 900px){
      .wrap{grid-template-columns: 1fr}
      aside{
        position:fixed; inset:54px auto 0 0; width:min(88vw, 360px);
        transform: translateX(-100%);
        transition: transform .25s ease;
        box-shadow: var(--shadow);
      }
      body.drawer-open aside{ transform: translateX(0); }
      body.drawer-open .scrim{ opacity:1; pointer-events:auto; }
    }
  </style>
</head>
<body>
  <header>
    <div class="left">
      <button id="btnMenu" aria-label="Toggle menu">☰</button>
      <h1>GI Symposium — Metro Map<span class="sub"> • drag to adjust • double‑click to rename</span></h1>
    </div>
    <div class="btn-row">
      <button id="btnFit">Fit</button>
      <button id="btnReset">Reset</button>
      <button id="btnSaveJSON">Save JSON</button>
      <label class="file btn"><input id="fileJSON" type="file" accept="application/json"/>Load JSON</label>
      <button id="btnShare">Copy Link</button>
      <button id="btnExportSVG">Export SVG</button>
      <button id="btnExportPNG">Export PNG</button>
    </div>
  </header>

  <div class="wrap">
    <aside>
      <div class="panel">
        <h3>View & Edit</h3>
        <div class="toggle">
          <label><input id="editMode" type="checkbox" checked/> Edit mode</label>
          <label><input id="snap" type="checkbox" checked/> Snap to grid</label>
          <label><input id="metro" type="checkbox" checked/> Metro lines</label>
          <label><input id="smooth" type="checkbox"/> Smooth curves</label>
          <label><input id="labels" type="checkbox" checked/> Station labels</label>
        </div>
        <div class="sep"></div>
        <div class="controls">
          <label for="grid">Grid size</label>
          <input id="grid" type="range" min="10" max="60" step="2" value="20" />
          <label for="width">Line width</label>
          <input id="width" type="range" min="8" max="18" step="1" value="12" />
        </div>
        <div class="sep"></div>
        <div id="legend"></div>
        <div class="hint">Mobile: long‑press (~0.5s) on a label to rename. Hold <b>Shift</b> while dragging to lock axis; hold <b>Alt</b> to bypass snap.</div>
      </div>
      <div class="panel">
        <h3>About</h3>
        <div class="hint">Self‑contained HTML. Works offline. <b>Autosaves locally</b> and you can <b>Copy Link</b> to encode the layout in the URL for easy sharing or bookmarking. JSON export is still there for versioning. Add <code>?edit=0</code> to share a read‑only view.</div>
      </div>
    </aside>

    <main id="stage">
      <svg id="svg" viewBox="0 0 1600 1000" xmlns="http://www.w3.org/2000/svg" aria-label="Interactive metro map">
        <defs>
          <filter id="softShadow" x="-50%" y="-50%" width="200%" height="200%">
            <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#000" flood-opacity=".08"/>
          </filter>
        </defs>
        <g id="grid"></g>
        <g id="routes" filter="url(#softShadow)"></g>
        <g id="stations"></g>
        <g id="talks"></g>
      </svg>
      <div class="zoom">
        <button id="zOut" aria-label="Zoom out">−</button>
        <button id="zIn" aria-label="Zoom in">+</button>
      </div>
      <div class="toast" id="toast">Saved</div>
    </main>
  </div>
  <div class="scrim" id="scrim"></div>

<script>
// Enhanced: auto-fit, viewer mode (?edit=0), legend isolate/hover, keyboard nudge, mobile drawer
(function(){
  'use strict';
  var svg = document.getElementById('svg');
  var stage = document.getElementById('stage');
  var gGrid = document.getElementById('grid');
  var gRoutes = document.getElementById('routes');
  var gStations = document.getElementById('stations');
  var gTalks = document.getElementById('talks');
  var legend = document.getElementById('legend');
  var btnRow = document.querySelector('.btn-row');
  var btnMenu = document.getElementById('btnMenu');
  var scrim = document.getElementById('scrim');

  var ui = {
    edit: document.getElementById('editMode'),
    snap: document.getElementById('snap'),
    metro: document.getElementById('metro'),
    smooth: document.getElementById('smooth'),
    labels: document.getElementById('labels'),
    grid: document.getElementById('grid'),
    width: document.getElementById('width')
  };

  var COLORS = {
    nic: css('--c-nic'), zoyander: css('--c-zoy'), alex: css('--c-alex'), eileen: css('--c-eileen'),
    flo: css('--c-flo'), laura: css('--c-laura'), srikkanth: css('--c-sri'), erin: css('--c-erin'),
    jack: css('--c-jack'), tom: css('--c-tom'), ricardo: css('--c-ric'), milica: css('--c-mil')
  };

  var DEFAULT = {
    grid: 20,
    stations: [
      {id:'neuro', label:'Neurodiversity', x:800, y:140},
      {id:'queer', label:'Queerness', x:520, y:300},
      {id:'char', label:'Character Creators', x:600, y:360},
      {id:'embody', label:'Embodiment', x:610, y:430},
      {id:'perform', label:'Performance', x:560, y:500},
      {id:'art', label:'Art', x:530, y:580},
      {id:'demo', label:'Game Demo', x:520, y:660},
      {id:'care', label:'Care', x:820, y:740},
      {id:'empathy', label:'Empathy', x:780, y:660},
      {id:'trauma', label:'Trauma', x:760, y:580},
      {id:'gamedesign', label:'Game Design', x:900, y:520},
      {id:'autoeth', label:'Autoethnography', x:920, y:440},
      {id:'learn', label:'Learning / Edutainment', x:1020, y:360},
      {id:'resist', label:'Resistance', x:1100, y:300},
      {id:'decol', label:'Decolonisation & Social Change', x:1120, y:220}
    ],
    talks: [
      {id:'nic', label:'Queering Play in The Sims 4', x:60, y:120, w:360, h:50, align:'left', color:COLORS.nic},
      {id:'zoyander', label:'Intrapology — Performance', x:60, y:540, w:360, h:50, align:'left', color:COLORS.zoyander},
      {id:'alex', label:'Role of (Queer) Body in Cosplay', x:60, y:260, w:360, h:50, align:'left', color:COLORS.alex},
      {id:'eileen', label:'Customizable Character Creators', x:60, y:320, w:360, h:50, align:'left', color:COLORS.eileen},
      {id:'flo', label:'In Other Bodies', x:60, y:380, w:360, h:50, align:'left', color:COLORS.flo},
      {id:'laura', label:"Congratulations, You've Chosen Poorly", x:800, y:60, w:560, h:50, align:'top', color:COLORS.laura},
      {id:'srikkanth', label:'Disruption through Strategic Game Design', x:1540, y:640, w:420, h:50, align:'right', color:COLORS.srikkanth},
      {id:'erin', label:'Game Design Justice: Community‑led Practice', x:1540, y:700, w:420, h:50, align:'right', color:COLORS.erin},
      {id:'jack', label:'No Diversity, No Games', x:1540, y:300, w:420, h:50, align:'right', color:COLORS.jack},
      {id:'tom', label:'An Afternoon at Home — Playtest & Discussion', x:1540, y:380, w:420, h:50, align:'right', color:COLORS.tom},
      {id:'ricardo', label:'Ascension Day — Game Demo', x:1540, y:460, w:420, h:50, align:'right', color:COLORS.ricardo},
      {id:'milica', label:'Social Innovation & Video Games', x:1540, y:520, w:420, h:50, align:'right', color:COLORS.milica}
    ],
    routes: [
      {talk:'nic', through:['queer','char','art','demo']},
      {talk:'zoyander', through:['perform','art','demo']},
      {talk:'alex', through:['queer','embody','perform']},
      {talk:'eileen', through:['char','demo']},
      {talk:'flo', through:['embody','art']},
      {talk:'laura', through:['neuro','queer','empathy','trauma']},
      {talk:'srikkanth', through:['resist','decol']},
      {talk:'erin', through:['learn','gamedesign','care']},
      {talk:'jack', through:['gamedesign']},
      {talk:'tom', through:['autoeth','gamedesign']},
      {talk:'ricardo', through:['gamedesign','care']},
      {talk:'milica', through:['care','gamedesign']}
    ]
  };

  var state = clone(DEFAULT);

  // === local persistence + share links
  var STORAGE_KEY='gi_symposium_map_state_v1';
  function saveLocal(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){} }
  function loadLocal(){ try{ var s=localStorage.getItem(STORAGE_KEY); if(s){ state=JSON.parse(s); return true; } }catch(e){} return false; }
  function loadFromHash(){
    try{
      if(location.hash && location.hash.indexOf('#state=')===0){
        var raw = decodeURIComponent(location.hash.slice(7));
        state=JSON.parse(raw); location.hash='';
        return true;
      }
    }catch(e){}
    return false;
  }
  function buildShareLink(){ try{ return location.origin+location.pathname+'#state='+encodeURIComponent(JSON.stringify(state)); }catch(e){ return ''; } }

  // helpers
  function css(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }
  function clone(o){ return JSON.parse(JSON.stringify(o)); }
  function qAll(sel){ return Array.from(document.querySelectorAll(sel)); }
  function getStation(id){ return state.stations.find(function(s){ return s.id===id; }); }
  function getTalk(id){ return state.talks.find(function(t){ return t.id===id; }); }
  function snapValue(n){
    if(!ui.snap.checked) return n;
    return Math.round(n/state.grid)*state.grid;
  }
  function talkExitPoint(t){
    if(t.align==='left') return {x:t.x+t.w, y:t.y};
    if(t.align==='right') return {x:t.x-t.w, y:t.y};
    if(t.align==='top') return {x:t.x, y:t.y+t.h/2};
    return {x:t.x+t.w, y:t.y};
  }
  function el(name, attrs){
    var n=document.createElementNS('http://www.w3.org/2000/svg', name);
    if(attrs){ for(var k in attrs){ if(Object.prototype.hasOwnProperty.call(attrs,k)){ n.setAttribute(k, String(attrs[k])); } } }
    return n;
  }
  function svgPointFrom(x,y){ var pt=svg.createSVGPoint(); pt.x=x; pt.y=y; return pt.matrixTransform(svg.getScreenCTM().inverse()); }

  // view / fit
  var view={x:0,y:0,w:1600,h:1000};
  function applyView(){ svg.setAttribute('viewBox', view.x+' '+view.y+' '+view.w+' '+view.h); }
  function fitToContent(){
    try{
      var boxes=[gRoutes,gStations,gTalks].map(function(g){ return g.getBBox(); });
      var minX=boxes.reduce(function(m,b){return Math.min(m,b.x);}, Infinity);
      var minY=boxes.reduce(function(m,b){return Math.min(m,b.y);}, Infinity);
      var maxX=boxes.reduce(function(m,b){return Math.max(m,b.x+b.width);}, -Infinity);
      var maxY=boxes.reduce(function(m,b){return Math.max(m,b.y+b.height);}, -Infinity);
      var pad=60; var w=maxX-minX, h=maxY-minY;
      if(!isFinite(w)||!isFinite(h)||w<=0||h<=0){ view={x:0,y:0,w:1600,h:1000}; applyView(); return; }
      view={x:minX-pad,y:minY-pad,w:w+pad*2,h:h+pad*2}; applyView();
    }catch(e){ view={x:0,y:0,w:1600,h:1000}; applyView(); }
  }

  document.getElementById('zIn').addEventListener('click', function(){ zoom(0.85); });
  document.getElementById('zOut').addEventListener('click', function(){ zoom(1.15); });
  function zoom(f){ var cx=view.x+view.w/2, cy=view.y+view.h/2; view.w*=f; view.h*=f; view.x=cx-view.w/2; view.y=cy-view.h/2; applyView(); }
  document.getElementById('btnFit').addEventListener('click', fitToContent);

  // draw
  var selected={kind:null,id:null};
  var hoverHighlight=null;
  var lockedHighlight=null;

  function drawGrid(){
    gGrid.innerHTML='';
    var step=state.grid; var x,y;
    for(x=0;x<=1600;x+=step){ gGrid.appendChild(el('line',{x1:x,y1:0,x2:x,y2:1000,'class':'grid'})); }
    for(y=0;y<=1000;y+=step){ gGrid.appendChild(el('line',{x1:0,y1:y,x2:1600,y2:y,'class':'grid'})); }
  }

  function draw(){
    document.documentElement.style.setProperty('--route', String(ui.width.value)+'px');

    // routes
    gRoutes.innerHTML='';
    state.routes.forEach(function(r){
      var t=getTalk(r.talk); var color=t.color;
      var pts=[ talkExitPoint(t) ].concat(r.through.map(getStation).map(function(s){ return {x:s.x,y:s.y}; }));
      var d = ui.metro.checked ? pathMetro(pts) : pathSmooth(pts);
      var p = el('path',{d:d,'class':'route',stroke:color,'stroke-width':getComputedStyle(document.documentElement).getPropertyValue('--route')});
      p.dataset.talk=r.talk;
      var activeId = lockedHighlight || hoverHighlight;
      if(activeId && activeId!==r.talk) p.classList.add('dim');
      p.addEventListener('pointerenter', function(){ if(!lockedHighlight) setHover(r.talk); });
      p.addEventListener('pointerleave', function(){ if(!lockedHighlight) clearHover(); });
      gRoutes.appendChild(p);
    });

    // stations
    gStations.innerHTML='';
    state.stations.forEach(function(s){
      var g = el('g',{'class':'station','data-id':s.id});
      var hit = el('circle',{cx:s.x, cy:s.y, r:22, fill:'transparent', 'class':'hit','data-kind':'station','data-id':s.id});
      var c = el('circle',{cx:s.x, cy:s.y, r:10}); if(selected.kind==='station' && selected.id===s.id) c.classList.add('sel');
      var t = el('text',{x:s.x+16,y:s.y+2,'data-kind':'station','data-id':s.id}); t.textContent=s.label;
      g.appendChild(hit); g.appendChild(c); g.appendChild(t); gStations.appendChild(g);
    });

    // talks
    gTalks.innerHTML='';
    state.talks.forEach(function(t){
      var g = el('g',{'class':'talk','data-id':t.id});
      var x = t.align==='left'? t.x : (t.align==='right'? (t.x-t.w) : (t.x - t.w/2));
      var y = t.y - t.h/2;
      var hit = el('rect',{x:x-8, y:y-8, width:t.w+16, height:t.h+16, fill:'transparent', 'class':'hit','data-kind':'talk','data-id':t.id});
      var r = el('rect',{x:x, y:y, width:t.w, height:t.h, stroke:t.color}); if(selected.kind==='talk' && selected.id===t.id) r.classList.add('sel');
      var label = el('text',{x:x+12,y:t.y+4,'data-kind':'talk','data-id':t.id}); label.textContent=t.label;
      g.appendChild(hit); g.appendChild(r); g.appendChild(label); gTalks.appendChild(g);
    });

    buildLegend();
    if(stage){ if(ui.labels.checked){ stage.classList.remove('hideLabels'); } else { stage.classList.add('hideLabels'); } }
  }

  // paths
  function pathSmooth(points){ if(points.length<2) return ''; var p = points.map(function(pt){ return {x:pt.x,y:pt.y}; }); var d='M '+p[0].x+' '+p[0].y; for(var i=0;i<p.length-1;i++){ var p0=p[i-1]||p[i]; var p1=p[i]; var p2=p[i+1]; var p3=p[i+2]||p2; var t=0.25; var cp1x=p1.x+(p2.x-p0.x)*t, cp1y=p1.y+(p2.y-p0.y)*t; var cp2x=p2.x-(p3.x-p1.x)*t, cp2y=p2.y-(p3.y-p1.y)*t; d+=' C '+cp1x+' '+cp1y+', '+cp2x+' '+cp2y+', '+p2.x+' '+p2.y; } return d; }
  function pathMetro(points){ if(points.length<2) return ''; var pts=points.map(function(p){ return {x:snapValue(p.x), y:snapValue(p.y)}; }); var d='M '+pts[0].x+' '+pts[0].y; for(var i=0;i<pts.length-1;i++){ var a=pts[i], b=pts[i+1], mid={x:b.x,y:a.y}; d+=' L '+mid.x+' '+mid.y+' L '+b.x+' '+b.y; } return d; }

  // delegated interactivity
  var drag=null, pressTimer=null;
  function beginDrag(obj, clientX, clientY, axisLock){
    var p=svgPointFrom(clientX, clientY);
    drag={obj:obj, sx:p.x, sy:p.y, ox:obj.x, oy:obj.y, moved:false, axis:axisLock||null};
    window.addEventListener('pointermove', onMove);
    window.addEventListener('pointerup', endDrag);
  }
  function onMove(e){
    if(!drag) return;
    var p=svgPointFrom(e.clientX,e.clientY);
    var dx=p.x-drag.sx, dy=p.y-drag.sy;
    if(!drag.moved && Math.abs(dx)+Math.abs(dy)>2) drag.moved=true;

    // axis lock with Shift
    if(drag.axis==='x') dy=0;
    if(drag.axis==='y') dx=0;

    var nx = drag.ox + dx;
    var ny = drag.oy + dy;

    // Alt bypasses snap
    var snappedX = e.altKey ? nx : snapValue(nx);
    var snappedY = e.altKey ? ny : snapValue(ny);

    drag.obj.x = snappedX;
    drag.obj.y = snappedY;
    draw();
  }
  function endDrag(){ window.clearTimeout(pressTimer); window.removeEventListener('pointermove', onMove); window.removeEventListener('pointerup', endDrag); drag=null; saveLocal(); }

  function renameObj(obj){ if(!ui.edit.checked) return; var v=window.prompt('Rename', obj.label||''); if(v!==null){ v=String(v).trim(); if(v){ obj.label=v; draw(); saveLocal(); } } }
  function pickTarget(el){ var kind=el.getAttribute('data-kind'); var id=el.getAttribute('data-id'); if(!kind||!id) return null; selected={kind:kind,id:id}; draw(); return (kind==='station')? getStation(id) : getTalk(id); }

  svg.addEventListener('pointerdown', function(e){
    var obj=pickTarget(e.target); if(!obj) return;
    if(!ui.edit.checked) return;
    e.preventDefault();
    if(e.shiftKey && !e.altKey){ renameObj(obj); return; }
    var axis = e.shiftKey ? (Math.abs(e.movementX)>=Math.abs(e.movementY) ? 'x' : 'y') : null;
    beginDrag(obj, e.clientX, e.clientY, axis);
    clearTimeout(pressTimer);
    pressTimer=setTimeout(function(){ if(drag && !drag.moved){ renameObj(obj); } }, 600);
  });
  svg.addEventListener('dblclick', function(e){ var obj=pickTarget(e.target); if(obj){ e.preventDefault(); renameObj(obj); }});
  svg.addEventListener('contextmenu', function(e){ var obj=pickTarget(e.target); if(obj){ e.preventDefault(); renameObj(obj); }});

  // keyboard nudge
  window.addEventListener('keydown', function(e){
    if(!ui.edit.checked) return; if(!selected.id) return;
    var obj = selected.kind==='station'? getStation(selected.id): getTalk(selected.id);
    if(!obj) return;
    var step = e.shiftKey ? state.grid*5 : state.grid;
    var handled=true;
    switch(e.key){
      case 'ArrowLeft': obj.x -= step; break;
      case 'ArrowRight': obj.x += step; break;
      case 'ArrowUp': obj.y -= step; break;
      case 'ArrowDown': obj.y += step; break;
      case 'Enter': renameObj(obj); break;
      default: handled=false;
    }
    if(handled){ e.preventDefault(); draw(); saveLocal(); }
  });

  // legend (hover + isolate on click)
  function buildLegend(){
    legend.innerHTML='';
    state.talks.forEach(function(t){
      var row=document.createElement('div'); row.className='legend-item'; row.dataset.tid=t.id;
      var sw=document.createElement('div'); sw.className='swatch'; sw.style.background=t.color; row.appendChild(sw);
      var label=document.createElement('label');
      var cb=document.createElement('input'); cb.type='checkbox'; cb.checked=true; cb.addEventListener('change', function(){ toggleRoute(t.id, cb.checked); });
      var span=document.createElement('span'); span.textContent=t.label; label.appendChild(cb); label.appendChild(span); row.appendChild(label);
      legend.appendChild(row);

      row.addEventListener('mouseenter', function(){ if(!lockedHighlight) setHover(t.id); });
      row.addEventListener('mouseleave', function(){ if(!lockedHighlight) clearHover(); });
      row.addEventListener('click', function(){
        lockedHighlight = (lockedHighlight===t.id) ? null : t.id;
        updateHighlightClasses();
      });
    });
    updateHighlightClasses();
  }
  function toggleRoute(id, vis){ qAll('.route[data-talk="'+id+'"]').forEach(function(p){ p.classList.toggle('hidden', !vis); }); }
  function setHover(id){ hoverHighlight=id; updateHighlightClasses(); }
  function clearHover(){ hoverHighlight=null; updateHighlightClasses(); }
  function updateHighlightClasses(){
    var activeId = lockedHighlight || hoverHighlight;
    qAll('.route').forEach(function(p){
      if(activeId && p.dataset.talk!==activeId) p.classList.add('dim'); else p.classList.remove('dim');
    });
    qAll('#legend .legend-item').forEach(function(r){
      var id=r.dataset.tid; r.classList.toggle('active', !!activeId && id===activeId);
    });
  }

  // file ops
  document.getElementById('btnReset').addEventListener('click', function(){ state=clone(DEFAULT); ui.grid.value=DEFAULT.grid; drawGrid(); draw(); saveLocal(); toast('Reset'); });
  document.getElementById('btnSaveJSON').addEventListener('click', function(){ download(new Blob([JSON.stringify(state,null,2)],{type:'application/json'}),'gi_symposium_metro_map.json'); });
  document.getElementById('fileJSON').addEventListener('change', function(e){ var f=e.target.files[0]; if(!f) return; var r=new FileReader(); r.onload=function(){ try{ state=JSON.parse(String(r.result)); ui.grid.value=state.grid||20; drawGrid(); draw(); saveLocal(); toast('JSON loaded'); }catch(err){ alert('Invalid JSON'); } }; r.readAsText(f); });
  document.getElementById('btnExportSVG').addEventListener('click', function(){ var s=new XMLSerializer().serializeToString(svg); download(new Blob([s],{type:'image/svg+xml'}),'gi_symposium_metro_map.svg'); });
  document.getElementById('btnExportPNG').addEventListener('click', function(){ var s=new XMLSerializer().serializeToString(svg); var img=new Image(); img.onload=function(){ var c=document.createElement('canvas'); c.width=3200; c.height=2000; var ctx=c.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,c.width,c.height); ctx.drawImage(img,0,0,c.width,c.height); c.toBlob(function(b){ download(b,'gi_symposium_metro_map.png'); }); }; img.src='data:image/svg+xml;charset=utf-8,'+encodeURIComponent(s); });
  document.getElementById('btnShare').addEventListener('click', function(){ var link=buildShareLink(); if(!link) return; if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(link).then(function(){ toast('Share link copied'); }, function(){ window.prompt('Copy link', link); }); } else { window.prompt('Copy link', link); } });

  // toggles
  ui.metro.addEventListener('change', function(){ if(ui.metro.checked) ui.smooth.checked=false; draw(); saveLocal(); });
  ui.smooth.addEventListener('change', function(){ if(ui.smooth.checked) ui.metro.checked=false; draw(); saveLocal(); });
  ui.labels.addEventListener('change', function(){ draw(); saveLocal(); });
  ui.grid.addEventListener('input', function(){ state.grid = Number(ui.grid.value); drawGrid(); draw(); saveLocal(); });
  ui.width.addEventListener('input', function(){ draw(); saveLocal(); });

  function download(blob, name){ var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(function(){ URL.revokeObjectURL(a.href); },4000); }
  function toast(msg){ var t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(function(){ t.classList.remove('show'); },1100); }

  // viewer mode via ?edit=0
  function applyViewerMode(){
    var params=new URLSearchParams(location.search);
    if(params.get('edit')==='0'){
      ui.edit.checked=false; ui.edit.disabled=true;
      var b=document.createElement('button'); b.textContent='Enable Edit';
      b.addEventListener('click', function(){ params.set('edit','1'); location.search='?'+params.toString(); });
      btnRow.appendChild(b);
    }
  }

  // mobile drawer
  function setDrawer(open){
    document.body.classList.toggle('drawer-open', !!open);
  }
  btnMenu.addEventListener('click', function(){ setDrawer(!document.body.classList.contains('drawer-open')); });
  scrim.addEventListener('click', function(){ setDrawer(false); });

  // init — prefer URL hash, then localStorage; auto-fit when fresh
  var loadedFromHash = loadFromHash();
  var loadedLocal = !loadedFromHash && loadLocal();
  if(state.grid) ui.grid.value = state.grid;
  drawGrid(); draw(); applyViewerMode();
  if(!loadedFromHash && !loadedLocal){ fitToContent(); }
  applyView(); saveLocal();
  window.addEventListener('resize', function(){ fitToContent(); });
})();
</script>
</body>
</html>
